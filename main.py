import os
import smtplib
import feedparser
import google.generativeai as genai
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
from datetime import datetime

# 1. è·å–ç¯å¢ƒå˜é‡
GEMINI_KEY = os.environ.get("GEMINI_API_KEY")
GMAIL_USER = os.environ.get("GMAIL_USER")
GMAIL_PASSWORD = os.environ.get("GMAIL_PASSWORD")
TO_EMAIL = GMAIL_USER 

# è¿™é‡Œæˆ‘æ¢äº†ä¸€ä¸ªæ›´ç¨³å®šçš„é›…è™è´¢ç» RSS æº
RSS_URL = "https://finance.yahoo.com/news/rssindex"

def get_latest_news():
    print("æ­£åœ¨æŠ“å–æœ€æ–°è´¢ç»æ–°é—»...")
    feed = feedparser.parse(RSS_URL)
    news_items = []
    
    # åªå–å‰ 8 æ¡
    for entry in feed.entries[:8]:
        # --- ä¿®å¤æ ¸å¿ƒï¼šæ›´å®‰å…¨çš„å­—æ®µè·å–æ–¹å¼ ---
        # å°è¯•è·å– summaryï¼Œå¦‚æœæ²¡æœ‰å°±è·å– descriptionï¼Œè¿˜æ²¡æœ‰å°±æ˜¾ç¤ºâ€œæš‚æ— è¯¦æƒ…â€
        # getattr(å¯¹è±¡, 'å±æ€§å', 'é»˜è®¤å€¼') æ˜¯ Python é˜²æ­¢æŠ¥é”™çš„å†™æ³•
        title = getattr(entry, 'title', 'æ— æ ‡é¢˜')
        summary = getattr(entry, 'summary', getattr(entry, 'description', 'æš‚æ— è¯¦ç»†å†…å®¹'))
        
        # ç»„åˆèµ·æ¥
        news_items.append(f"- æ ‡é¢˜: {title}\n  ç®€ä»‹: {summary}")
        
    return "\n".join(news_items)

def get_ai_report(news_data):
    print("æ­£åœ¨è®© Gemini æ’°å†™åˆ†ææŠ¥å‘Š...")
    genai.configure(api_key=GEMINI_KEY)
    model = genai.GenerativeModel('gemini-pro-latest')
    
    today = datetime.now().strftime("%Y-%m-%d")
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½èµ„æ·±çš„åå°”è¡—è´¢ç»åˆ†æå¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹æŠ“å–åˆ°çš„æœ€æ–°è´¢ç»æ–°é—»ï¼Œä¸ºæˆ‘æ’°å†™ä¸€ä»½ã€{today} å…¨çƒç»æµæ—©æŠ¥ã€‘ã€‚
    
    ã€æ–°é—»æ•°æ®ã€‘ï¼š
    {news_data}
    
    ã€æ’°å†™è¦æ±‚ã€‘ï¼š
    1. é£æ ¼ï¼šä¸“ä¸šã€ç®€æ´ã€å®¢è§‚ï¼Œç±»ä¼¼å½­åšç¤¾ç®€æŠ¥ã€‚
    2. ç»“æ„ï¼š
       - ğŸŒ **å¸‚åœºç»¼è¿°**ï¼šç”¨ä¸€å¥è¯æ€»ç»“å½“å‰å¸‚åœºæƒ…ç»ªã€‚
       - ğŸš€ **é‡ç‚¹å…³æ³¨**ï¼šä»æ–°é—»ä¸­æŒ‘å‡º 3 ä¸ªæœ€é‡è¦çš„äº‹ä»¶è¿›è¡Œæ·±åº¦è§£è¯»ã€‚
       - ğŸ“‰ **é£é™©æç¤º**ï¼šæ½œåœ¨çš„é£é™©ç‚¹ã€‚
    3. æ ¼å¼ï¼š**å¿…é¡»ç›´æ¥è¾“å‡º HTML ä»£ç **ï¼Œä¸è¦åŒ…å« markdown æ ‡è®°ï¼ˆå¦‚ ```htmlï¼‰ã€‚
       - ä½¿ç”¨ <h2> ä¿®é¥°å°æ ‡é¢˜ï¼Œé¢œè‰²ä½¿ç”¨æ·±è“è‰²ã€‚
       - ä½¿ç”¨ <ul> å’Œ <li> åˆ—å‡ºè¦ç‚¹ã€‚
       - é‡ç‚¹è¯æ±‡ç”¨ <b> åŠ ç²—ã€‚
       - ç»“å°¾åŠ ä¸Šä¸€å¥ï¼šâ€œGenerated by Gemini AIâ€.
    """
    
    try:
        response = model.generate_content(prompt)
        # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ markdown æ ‡è®°
        return response.text.replace("```html", "").replace("```", "")
    except Exception as e:
        return f"<p>AI ç”ŸæˆæŠ¥å‘Šå¤±è´¥: {str(e)}</p>"

def send_email(html_content):
    print("æ­£åœ¨å‘é€é‚®ä»¶...")
    msg = MIMEMultipart()
    subject_date = datetime.now().strftime("%mæœˆ%dæ—¥")
    msg['From'] = Header(f"Gemini Analyst <{GMAIL_USER}>", 'utf-8')
    msg['To'] = Header("Boss", 'utf-8')
    msg['Subject'] = Header(f"ğŸ“Š æ¯æ—¥ç»æµæ—©æŠ¥ ({subject_date})", 'utf-8')
    
    msg.attach(MIMEText(html_content, 'html', 'utf-8'))
    
    try:
        server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
        server.login(GMAIL_USER, GMAIL_PASSWORD)
        server.sendmail(GMAIL_USER, [TO_EMAIL], msg.as_string())
        server.quit()
        print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼")
    except Exception as e:
        print(f"âŒ å‘é€å¤±è´¥: {e}")

if __name__ == "__main__":
    if not GEMINI_KEY:
        print("âŒ ç¼ºå°‘ API Keyï¼Œè¯·æ£€æŸ¥ Secrets è®¾ç½®")
    else:
        try:
            raw_news = get_latest_news()
            # åªæœ‰æŠ“å–åˆ°æ–°é—»æ‰ç»§ç»­
            if raw_news:
                report = get_ai_report(raw_news)
                send_email(report)
            else:
                print("âš ï¸ æœªæŠ“å–åˆ°æ–°é—»æ•°æ®")
        except Exception as e:
            print(f"âŒ è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
